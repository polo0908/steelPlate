<%@ page language="java" contentType="text/html; charset=utf-8"
		pageEncoding="utf-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Calculator</title>
<!--  <link rel="stylesheet" href="css/bootstrap.min.css"/> -->
<!--  <link rel="stylesheet" href="css/bootstrap-responsive.min.css"/> -->
<!--  <link rel="stylesheet" href="css/matrix-style.css"/> -->
<!--  <link rel="stylesheet" href="css/matrix-media.css"/> -->
 <link href="css/font-awesome.css" rel="stylesheet"/>
<script type="text/javascript" src="<%=request.getContextPath()%>/calculator/js/jquery-1.8.2.min.js"></script>
<link rel="stylesheet" href="<%=request.getContextPath()%>/calculator/css/calculator.css" />
<link rel="stylesheet" href="css/calculator4.css"/>
<link rel="stylesheet" href="css/easydialog.css" />
<script type="text/javascript" src="js/easydialog.min.js"></script> 		
<script type="text/javascript" src="<%=request.getContextPath()%>/calculator/js/calculator.js"></script>
<style>
.sub_item li{width:100%;}
.sub_item li span{width:100%;display:inline-block; white-space: nowrap; word-break: break-all;}
</style>
<script>
	$(function() {
		var p = "";
		$(".father_product li").click(
						function() {
							var q = $(this).find("span").html();
						    if(p == q){
						    	return false;
						    }else{
						       p = q;
						    }
							$(".dimensions").html("");
							$(this).addClass("active").siblings().removeClass("active");
							var parameter = $(this).find("input:eq(0)").val();
							var list = parameter.split("/");
							var txt_lis = "";						    
							for(var i = 0; i < list.length; i++){
								txt_lis += "<li class=\"txt_li\"><span>"+list[i]+"</span>"
								+ " <div class=\"input-group\"> <input class=\"form-control\" type=\"text\"> <span class=\"input-group-btn\"> mm</span></div> </li>"															
							}
							
							$(".dimensions").append(txt_lis);
							//存储首页点击数据
							 localStorage.sitename= $(this).index();
							var name = $(this).find("span").html();
							$(".plate i:eq(0)").html($(this).find("span").html());
							var goodsType = $(".plate i:eq(0)").html();
				 			$.post(
				 					"/steelPlate/calculator/queryByGoodsType.do",
				 					{
				 					 "goodsType":goodsType,
				 					 "currencyShorthand" : $('#select_currency').val()
				 				    },
				 				   function(result){
				     	            var txt_lis = "";
				 				    if(result.state == 0){
				 				    	
				 				    	//判断标准参数是否存在（不存在的 Plates,Round rod (round stick),Flat bar,Square bar）
				 				    	
				 				     if(goodsType == 'Plates' || goodsType == 'Round rod (round stick)' || goodsType == 'Flat bar' ||  goodsType == 'Square bar'){
				 				    	$(".dimensions").prev().prev().hide();
				 				     }else{
				 				    	$(".dimensions").prev().prev().show();
				 				     }				 				    			 				    	
				 				    	
				 				      $(".sub_item").html("");
				 					  var list = result.data.materialInfos;
				 					  var unitPrice = result.data.unitPrice;
				 					  
				 						if(unitPrice == "null"){
				 							$(".plate .form-control-price").text(0);	
				 						}else{
				 							$(".plate .form-control-price").text(unitPrice);	
				 						}	
					 				 $(".plate i:eq(1)").html(list[0].materialType);	
				 						
				 					  for(var i = 0; i < list.length; i++){
				 						var materialType =  list[i].materialType;
				 						var din =  list[i].din;
				 						var astm =  list[i].astm;
				 						if(i == 0){
					 							txt_lis+="<li class='active'><span>"+materialType+"</span></li>"; 
					 							$('.plate').find('i:last').html(list[i].updateDate);	 					
				 						}else{				
					 							txt_lis+="<li><span>"+materialType+"</span></li>"; 	 	
				 						}
			 						
				 					  }
				 					  $(".sub_item").append(txt_lis);
				 					  
				 					
				 					$(".item_box_img img").attr("src",result.data.goodsImage);  
				 					  //初始参数赋值
				 					 var parameter = result.data.originalParameter;				    	
								    	var s = parameter.split(",");
							 			var tl = s.length;
							             if(tl == 0){
							             	return false;
							             }          
			 						$(".dimensions li").each(function(index, element) {
						 				var type = $(this).find("span").html();
						 				$(this).find("input").val();
						                 for(var i=0;i<tl;i++){
						                   var w = s[i].split(":");
						                   if(w[0] == type){
						                 	$(this).find("input").val(w[1]); 
						                   }
						               }						                 
			 						
			 						})				
				 					  
				 					  
							           
				 				  }else{
				 					 easyDialog.open({
							    		  container : {
							    		    header : 'Prompt message',
							    		    content : 'Query failed'
							    		  },
							    		  overlay : false,
							    		  autoClose : 1000
							    		}); 
				 				  }
								  
				 			  });
		});
		
	
		$("body").on("click",".sub_item li",function(){
			$(this).addClass("active").siblings().removeClass("active");
			$(".plate i:eq(1)").html($(this).find("span").text());
			var materialType = $(this).find("span").text();
			var goodsType = $(".plate i:eq(0)").text();
			
			$.ajax({
	    		url : '/steelPlate/calculator/queryUnitPriceByMaterialInfo.do',
				method : 'post',
				data : {"goodsType":goodsType,
	        		    "materialType" : materialType,
	        		    "currencyShorthand" : $('#select_currency').val()
        	           },
				success : function(result) { 
					
				if(result.state == 0){
						if(result.data.price == "null"){
							$(".plate .form-control-price").text(0);	
						}else{
							$(".plate .form-control-price").text(result.data.price);
							$('.plate').find('i:last').html(result.data.updateDate);
						}
				    }	
				},
				error : function(msg) {
					easyDialog.open({
			    		  container : {
			    		    header : 'Prompt message',
			    		    content : 'No price has been found'
			    		  },
			    		  overlay : false,
			    		  autoClose : 1000
			    		}); 
				}
	    	})
			
			 
		})
		$(".father_product li:first").click();
		

		$("#sub1").click(function() {
			if($(".sub_item li.active").length==0){
				easyDialog.open({
		    		  container : {
		    		    header : 'Prompt message',
		    		    content : 'Please select material'
		    		  },
		    		  overlay : false,
		    		  autoClose : 1000
		    		}); 
				return;
			}
			var parameterMm = "";
			var parameterInch = "";
			var conversion = 25.4;
			var inch = 0;
			var mm = 0;
			var check_flag=false;
			$(".dimensions input[type='text']").each(function(index, element) {
			    if($(this).val()==""){
			    	 easyDialog.open({
			    		  container : {
			    		    header : 'Prompt message',
			    		    content : $(this).parent().prev().html() +' can not empty'
			    		  },
			    		  autoClose : 1000
			    		}); 			    	
			    	
			    	$(this).focus();
			    	check_flag=false;
			    	return false;
				}else{
					check_flag=true;
				}
			});
			if(!check_flag){
				return;
			}
			
			//防止重复点击
			$('#sub1').css({"background-color":"#666"}).attr("disabled","true");
			
			
			//获取产品数据的json串
			$(".dimensions li").each(function(index, element) {
				if(index==$(".dimensions li").length-1){
					if($(".unit .form_select").val() == 'mm'){
						parameterMm +="\""+$(this).find("span").html()+"\""+":"+"\""+$(this).find("input").val()+"\"";
						mm = $(this).find("input").val();
						inch = mm/conversion;
						parameterInch +="\""+$(this).find("span").html()+"\""+":"+"\""+inch+"\"";
					}
					if($(".unit .form_select").val() == 'inch'){
						parameterInch +="\""+$(this).find("span").html()+"\""+":"+"\""+$(this).find("input").val()+"\"";
						inch = $(this).find("input").val();
						mm = inch*conversion;
						parameterMm +="\""+$(this).find("span").html()+"\""+":"+"\""+mm+"\"";
					}
					
				}else{
					if($(".unit .form_select").val() == 'mm'){
						parameterMm +="\""+$(this).find("span").html()+"\""+":"+"\""+$(this).find("input").val()+"\",";
						mm = $(this).find("input").val();
						inch = mm/conversion;
						parameterInch +="\""+$(this).find("span").html()+"\""+":"+"\""+inch+"\",";
					}
					if($(".unit .form_select").val() == 'inch'){
						parameterInch +="\""+$(this).find("span").html()+"\""+":"+"\""+$(this).find("input").val()+"\",";
						inch = $(this).find("input").val();
						mm = inch*conversion;
						parameterMm +="\""+$(this).find("span").html()+"\""+":"+"\""+mm+"\",";
					}
				}
			});

			parameterMm="{"+parameterMm.substring(0)+"}";
			parameterInch="{"+parameterInch.substring(0)+"}";

			var goodsType = $(".plate i:eq(0)").html();
			var materialType = $(".plate i:eq(1)").html();
			var partName = $(".item_box_img input:eq(0)").val();
			var quantity = $(".item_box_img input:eq(1)").val();
			var price = $(".plate .form-control-price").text();

		   $.post(
					"/steelPlate/calculator/saveClientOrder.do",
					{"goodsType":goodsType,
	        		    "materialType" : materialType,
	        		    "partName" : partName,
	        		    "quantity" : quantity,
	        		    "price"    : price,
	        		    "parameterMm" : parameterMm,
	        		    "parameterInch" : parameterInch,
	        		    "currencyShorthand" : $('#select_currency').val()
	        	       },
			function(result){  
	        	    	   
				 $('#sub1').css({"background-color":"#5d9cec"}).removeAttr("disabled");  	   
				  if(result.state == 0){
				    	var id = result.data.id;	
						window.location.href ="/steelPlate/calculator/queryAllProcess.do?orderDetailsId="+id;
		           
				  }else{
					  easyDialog.open({
			    		  container : {
			    		    header : 'Prompt message',
			    		    content : 'Failed to generate'
			    		  },
			    		  overlay : false,
			    		  autoClose : 1000
			    		}); 
				  }
			  
			  });
		});

		
		// 乘法
		Number.prototype.mul = function(arg) {
		    var m = 0, s1 = this.toString(), s2 = arg.toString();
		    try{m += s1.split(".")[1].length;}catch(e){}
		    try{m += s2.split(".")[1].length;} catch(e){}
		    return Number(s1.replace(".", "")) * Number(s2.replace(".", ""))/ Math.pow(10, m);
		};
		// 除法
		Number.prototype.div = function(arg) {
		    var t1 = 0, t2 = 0, r1, r2;
		    try {t1 = this.toString().split(".")[1].length;}catch(e){}
		    try {t2 = arg.toString().split(".")[1].length;}catch(e){}
		    with (Math) {
		        r1 = Number(this.toString().replace(".", ""));
		        r2 = Number(arg.toString().replace(".", ""));
		        return (r1 / r2) * pow(10, t2 - t1);
		    }
		};
		
		
		$(".unit select").change(function(){
			$(".dimensions .input-group-btn").html($(this).val());
			$(".dimensions li").each(function(index, element) {
				if($(".unit .form_select").val() == 'mm'){
					var inch = $(this).find("input").val();
					if(inch!=""){
						var n1=Number(parseFloat(inch)).mul(25.4).toFixed(2);
						$(this).find("input").val(n1);
					}
				}
				if($(".unit .form_select").val() == 'inch'){					
					var mm = $(this).find("input").val();
					if(mm!=""){
						var n2=Number(parseFloat(mm)).div(25.4);
						$(this).find("input").val(n2);
					}
					
				}				
			
		  });

		})	   

		
		/**
		 *获取汇率事件
	     */
		$('#select_currency').change(function(){
			var goodsType = $(".plate i:eq(0)").html();
			var materialType = $(".plate i:eq(1)").html();
			$.ajax({
	    		url : '/steelPlate/calculator/queryByCurrencyShorthand.do',
				method : 'post',
				data : {
					    "goodsType" : goodsType,
					    "materialType" : materialType,
	        		    "currencyShorthand" : $('#select_currency').val()
        	           },
				success : function(result) { 
					if(result.price == "null"){
						$(".plate .form-control-price").text(0);	
					}else{
						$(".plate .form-control-price").text(result.price);	
					}
					if($('#select_currency').val() == 'USD'){
						$('.red_txt').text($('#rate_cny').val()+"CNY/USD");	
					}else{
						$('.red_txt').text(result.exchangeRate+$('#select_currency').val()+"/USD");	
					}
					
				},
				error : function(msg) {
					easyDialog.open({
			    		  container : {
			    		    header : 'Prompt message',
			    		    content : 'No price has been found'
			    		  },
			    		  autoClose : 2000
			    		}); 
				}
	    	})	
						
					
		});		
		
		
		
		
}) 


    //根据材料类型查看标准参数
    
    function query_standard(){		
		var goodsType = $(".plate i:eq(0)").html();
		
		
		
		 $.post(
				 "/steelPlate/calculator/queryStandardByGoodsTypeId.do",
					{
					 "goodsType" : goodsType				    	       
					},
			function(result){	
				    if(result.state == 0){
				    	$('#DataTables_Table_0_wrapper').empty();
				    	var goodsTypeNormals = result.data.goodsTypeNormals;
				    	var list = result.data.list;
				    	var tl = goodsTypeNormals.length;
				    	var ul = "";
				    	var title = "";		    	
				    	
				    	for(var i=0;i<tl;i++){
				    		var li_tl = list[i].length;		
				    		var li = "";
				            var type = "";
				    		for(var j=0;j<li_tl;j++){
				    			var w = list[i][j].split(":");
				    			var type1 = '<li>'+w[0]+'(mm)</li>';
				    			var li1 = '<li>'+w[1]+'</li>';
				    			type +=type1;
				    			li +=li1;
				    		}
				    		
				    		title = '<ul><h3 class="w-text">Choose the standard you need</h3></ul>'+
				    		        '<ul>'+
				    		        '<li>Type</li>'+type+
				    		        '<li>Operation</li>'+
				    		        '</ul>';
				    		        
				    		ul = '<ul>'+
				    		     '<li>'+(goodsTypeNormals[i].parameterType == null ? '' : goodsTypeNormals[i].parameterType)+'</li>'+li+
				    		     '<li><button onclick="select_standard('+goodsTypeNormals[i].id+')">select</button></li>'+
				    		     '</ul>';	     
					    	$('#DataTables_Table_0_wrapper').append(ul);			 	   
				    	}
				    	 $('#DataTables_Table_0_wrapper').find('ul:first').before(title);

				    	 var s_tl = $('#DataTables_Table_0_wrapper').find('ul:eq(1)').find('li').length;
						 var width = Math.floor(98/s_tl);
						 $("#DataTables_Table_0_wrapper").find('li').css({"width":width + "%"});
				    	 $('.wrapper').hide();
				    	 $('#back_select').show();
				    	 $('.w-big-box').show();
				    	
				    	
				    }else{
				    	easyDialog.open({
				    		  container : {
				    		    header : 'Prompt message',
				    		    content : 'No data was found'
				    		  },
				    		  autoClose : 1000
				    		}); 
				    }
				    
			   })  
			
	}
	
	//选择标准参数
   function select_standard(standardId){
	   
  	   $('.w-big-box').hide();
  	   $('#back_select').hide();
	   $.post(
				 "/steelPlate/calculator/queryByStandardId.do",
					{
					 "standardId" : standardId				    	       
					},
			function(result){	
				    $('.wrapper').show();
				    if(result.state == 0){
				    	var parameter = result.data.parameterNormal;				    	
				    	var s = parameter.split(",");
			 			var tl = s.length;
			             if(tl == 0){
			             	return false;
			             }         
			 			$(".dimensions li").each(function(index, element) {
			 				var type = $(this).find("span").html();
			 				$(this).find("input").val();
			                 for(var i=0;i<tl;i++){
			                   var w = s[i].split(":");
			                   if(w[0] == type){
			                 	$(this).find("input").val(w[1]); 
			                   }
			                }				
						   
			               if(type == 'length'){
			            	   $(this).find("input").focus(); 
			               }  
			                 
			 			})
				    	
				    	
				    }else{
				    	easyDialog.open({
				    		  container : {
				    		    header : 'Prompt message',
				    		    content : 'No data was found'
				    		  },
				    		  autoClose : 1000
				    		}); 
				    }
				  
			})		    
   }
     
	
	//处理显示
	function show_orderDetails(){
   	 $('.wrapper').show();
	 $('#back_select').hide();
	 $('.w-big-box').hide();
	}
        

</script>
<style>
 a:hover{cursor:pointer;}
.w-big-box{margin: 0 auto;
    width: 980px;}
     #DataTables_Table_0_wrapper ul:last-child li{border-bottom:1px solid #CDCDCD;}
     #DataTables_Table_0_wrapper li{width:30%; height:30px; float:left;white-space:nowrap;border-top: 1px solid #CDCDCD;border-left: 1px solid #CDCDCD;
     text-align: center;
    	line-height: 30px;} 
    	.w-text{padding:10px;}
        #DataTables_Table_0_wrapper ul:nth-of-type(2) li{background: #efefef;} 
</style>
</head>
<body> 

		<div class="wrapper w-wrapper" style="display: block;">
			<div class="w-email"> Email us : <a href="mailto:rfq@csmfg.com">RFQ@csmfg.com</a></div>
		<div class="location z-location" id="back_select" style="display: none;">
		  <a onclick="show_orderDetails()"><img src="images/back.jpg">Back</a>
      </div>  
			<h1 class="w-text-h1">STEEL FABRICATION PRICE CALCULATOR</h1>
				<h2 class="title_h2">Calculate the first part(you can add more parts later)</h2>
				<div class="choose_box">
						<div class="item_box">
								<h3 class="title_h3">Step 1: Choose the Material</h3>
								<ul class="item_list father_product">
								<c:forEach var="obj" items="${goodsTypeInfos}" varStatus="i">   
								<li><span>${obj.goodsType}</span><input value="${obj.parameter}" type="hidden"><input value="${obj.id}" type="hidden"><em class="fa fa-fw"></em></li>								
								</c:forEach>
								</ul>
						</div>
						<div class="item_box w-item_box">
								<h3 class="title_h3">&nbsp;</h3>
								<ul class="item_list sub_item">
								<c:forEach var="obj" items="${materialInfos}" varStatus="i"> 
                                <li>${obj.materialType}</li>
                                </c:forEach>
								</ul>
						</div>
						<div class="item_box">
								<div class="unit z-unit">
										Unit <select name="select" class="form_select" id="select_unit">
												<option value="mm">mm</option>
												<option value="inch">inch</option>
										</select>
								</div>
								<div class="z-unit">
										Standard:<br>
										<a style="color: #08c; text-decoration: underline;" onclick="query_standard()">view the regular sizes</a>
								</div>
								<h3 class="title_h3 z-title-h3">Dimensions:</h3>
								<ul class="item_list dimensions"> 
                                <li price=""><em class="fa fa-fw"></em></li>
								</ul>
						</div>
						<div class="item_box_img">
								<img src="${goodsTypeInfo.goodsImage}" /> <a href="#">View the material
										detail</a>					
								<p>
										<span>Part Name:</span> <input type="text" id="partName" 
												placeholder="can be left blank" />
								</p>
								<p>
										<span>Qty per set:</span> <input type="text" id="quantity" placeholder="" class="form-control" value="1"/>
								</p>
						</div>
				</div>
				<div class="plate" style="position: relative;">
						<strong>What you have chosen is:</strong><em><i>Plates</i>/<i>Q235</i></em>
							<em><i class="form-control-price w-form-control">${price}</i>&nbsp;&nbsp;
							<select id="select_currency">
							<c:forEach var="obj" items="${amountUnits}" varStatus="i">   
							    <option value="${obj.currencyShorthand}">${obj.currencyShorthand}/TON</option>							    
							</c:forEach>
							</select>
<!-- 						<span style="right: 10px;position: absolute; top: 6px;">	 -->
<%-- 						<strong>Exchange Rate:</strong><span class="red_txt">${amountUnit.exchangeRate}CNY/USD</span> --%>
<!-- 						</span> -->
							</em>
							<em><i>Updated On</i> <i>${materialInfos.get(0).updateDate}</i></em>
				</div>
				<div class="btn_box">
						<input type="submit" value="submit" id="sub1"
								class="btn btn-primary" style="float:right;"/>
				</div>
				<input type="hidden" value="${amountUnit.exchangeRate}" id="rate_cny"/>
		</div>

<div class="w-big-box" style="display:none;">
    <div class="container-fluid">
       <div class="row-fluid">
            <div class="span12">
                <div class="w-widget-box">

                    <div class="w-widget-content nopadding">
                        <div id="DataTables_Table_0_wrapper" role="grid">
                                <ul>
                                <li></li>
                                </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>

</div>
</body>
</html>
